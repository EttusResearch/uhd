parameters:
- name: uhdSrcDir
  type: string
- name: uhdBuildDir
  type: string
- name: uhdAllowWarnings
  type: boolean
  default: false
- name: uhdCxxFlags
  type: string
  default: ""
- name: cmake_args
  type: string
  default: " "

steps:
- script: |
    mkdir -p ${{ parameters.uhdBuildDir }}
    cd ${{ parameters.uhdBuildDir }}
    if [[ "${{ parameters.uhdAllowWarnings }}" = "False" ]]; then
      echo "Warnings not allowed for this build."
      export CXXFLAGS="-Werror -Wno-error=maybe-uninitialized $CXXFLAGS"
    fi
    export CXXFLAGS="${{ parameters.uhdCxxFlags }} $CXXFLAGS"
    if [[ "${{ parameters.cmake_args }}" != " " ]]; then
      echo "Adding additional cmake args: ${{ parameters.cmake_args }}"
    fi
    cmake -G Ninja ${{ parameters.cmake_args }} ${{ parameters.uhdSrcDir }}/host
  displayName: cmake ninja UHD
- script: |
    cd ${{ parameters.uhdBuildDir }}
    ninja
  displayName: ninja UHD
- script: |
    cd ${{ parameters.uhdBuildDir }}
    ctest --no-compress-output --output-on-failure -T test
  continueOnError: true
  displayName: ctest ninja UHD
